<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF → MOBI (via EPUB) — Storedropship</title>
  <meta name="description" content="Convert PDF to MOBI-friendly EPUB in the browser, then convert EPUB→MOBI with Calibre or Kindle tools. Client-side text extraction with PDF.js and EPUB packaging with JSZip." />
  <meta name="keywords" content="PDF to MOBI, PDF to EPUB, convert PDF to mobi, epub generator, client-side pdf conversion" />
  <style>
    :root{--bg:#fbfdff;--card:#fff;--muted:#6b7280;--accent:#ff6b6b}
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#eef6ff);padding:18px;color:#0b1220}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 34px rgba(10,20,40,0.06);margin-bottom:14px}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 12px;color:var(--muted)}
    label{display:block;font-size:13px;color:#374151;margin-top:8px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e9f0f6;font-size:14px}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    button.primary{background:var(--accent);color:#fff;border:none;padding:10px;border-radius:8px;cursor:pointer}
    button.alt{background:#fff;border:1px solid #e9f0f6;color:#0b5394;padding:10px;border-radius:8px}
    pre{background:#f8fafc;padding:12px;border-radius:8px;border:1px solid #e6e9ef;overflow:auto;max-height:420px;white-space:pre-wrap}
    .meta{font-size:13px;color:var(--muted);margin-top:8px}
    .row{display:grid;grid-template-columns:1fr 420px;gap:12px}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    code{background:#fff;border-radius:4px;padding:2px 6px;font-family:ui-monospace,monospace}
  </style>
  <!-- PDF.js and JSZip -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>PDF → MOBI (workflow)</h1>
      <p class="lead">This tool extracts selectable text from a PDF in your browser, packages it into a valid EPUB (client-side), and lets you download the EPUB. EPUB files can be converted to MOBI using Calibre or Kindle Previewer (instructions included below). This approach keeps your files private (no uploads).</p>

      <div class="row">
        <div>
          <label for="pdfFile">Choose PDF file</label>
          <input id="pdfFile" type="file" accept="application/pdf" />

          <label for="title" style="margin-top:8px">Book title</label>
          <input id="title" placeholder="My Book Title" />

          <label for="author" style="margin-top:8px">Author</label>
          <input id="author" placeholder="Author name" />

          <div class="controls">
            <button id="buildEpub" class="primary">Build EPUB (client-side)</button>
            <button id="previewText" class="alt">Preview Extracted Text</button>
            <button id="clearBtn" class="alt">Clear</button>
          </div>

          <div class="meta">Important: This tool extracts <b>selectable</b> text from PDFs. Scanned PDFs (images) require OCR — see note below. EPUB created here is basic (text + page chapters) and intended for conversion to MOBI using Calibre.</div>
        </div>

        <div>
          <label>Preview / Output</label>
          <pre id="preview">No output yet.</pre>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="downloadEpub" class="alt">Download EPUB</button>
            <button id="openEpub" class="alt">Open EPUB (new tab)</button>
          </div>
        </div>
      </div>

    </div>

    <div class="card">
      <h2>How to get MOBI</h2>
      <p style="margin:0;color:#374151;line-height:1.6">After you download the EPUB produced by this tool, convert EPUB → MOBI using one of these options:</p>
      <ol style="margin-top:8px;color:#374151">
        <li><b>Calibre (recommended):</b> Install Calibre (desktop). Run in terminal: <code>ebook-convert input.epub output.mobi</code> or use Calibre's GUI to add EPUB and convert to MOBI.</li>
        <li><b>Kindle Previewer / KindleGen:</b> Amazon's tools can convert EPUB to Kindle formats.</li>
        <li><b>Online converters:</b> Many web services convert EPUB→MOBI. Use if you trust the service.</li>
      </ol>
      <p class="meta">Why EPUB→MOBI and not direct PDF→MOBI in-browser? Creating a correct MOBI in-browser requires complex binary formats and third-party binary toolchains (Calibre/Kindlegen). Building EPUB is straightforward and standard; conversion to MOBI is a well-supported step using Calibre or Kindle tools.</p>
    </div>

    <div class="card">
      <h2>Limitations & OCR</h2>
      <p style="margin:0;color:#374151;line-height:1.6">This tool does <b>not</b> perform OCR. If your PDF is scanned (images of pages) you should first run OCR. Optionally I can add Tesseract.js integration to do OCR client-side (slower but keeps files local). EPUB produced here focuses on text — images, complex layouts, tables, or advanced styling will not be preserved.</p>
    </div>
  </div>

  <script>
    const pdfFile = document.getElementById('pdfFile');
    const buildEpubBtn = document.getElementById('buildEpub');
    const previewTextBtn = document.getElementById('previewText');
    const preview = document.getElementById('preview');
    const downloadEpubBtn = document.getElementById('downloadEpub');
    const openEpubBtn = document.getElementById('openEpub');
    const clearBtn = document.getElementById('clearBtn');
    const titleEl = document.getElementById('title');
    const authorEl = document.getElementById('author');

    let lastEpubBlob = null;
    let extractedTextByPage = null;

    async function extractPdfText(arrayBuffer){
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      const pages = [];
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(i => i.str);
        // Join items with spaces and normalize whitespace
        let joined = strings.join(' ').replace(/\s+/g,' ').trim();
        pages.push({page:p, text: joined});
      }
      return pages;
    }

    function makeEpubStructure(meta, pages){
      // meta: {title,author,uid}
      // pages: [{page, text}]
      const uid = meta.uid || ('urn:uuid:' + crypto.randomUUID());
      const title = meta.title || 'Converted Book';
      const author = meta.author || 'Unknown';

      const zip = new JSZip();
      // mimetype — MUST be uncompressed and first entry per EPUB spec
      zip.file('mimetype','application/epub+zip',{compression:'STORE'});

      // META-INF/container.xml
      zip.file('META-INF/container.xml', `<?xml version="1.0"?>\n<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">\n  <rootfiles>\n    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>\n  </rootfiles>\n</container>`);

      // OEBPS: XHTML files for pages
      const manifestItems = [];
      const spineItems = [];
      pages.forEach((p, idx) => {
        const fname = `OEBPS/page-${p.page}.xhtml`;
        const xhtml = `<?xml version="1.0" encoding="utf-8"?>\n<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml">\n<head><title>Page ${p.page}</title><meta charset="utf-8"/></head><body><h2>Page ${p.page}</h2><p>${escapeHtml(p.text)}</p></body></html>`;
        zip.file(fname, xhtml);
        manifestItems.push(`<item id="item${idx+1}" href="page-${p.page}.xhtml" media-type="application/xhtml+xml"/>`);
        spineItems.push(`<itemref idref="item${idx+1}"/>`);
      });

      // content.opf
      const contentOpf = `<?xml version="1.0" encoding="utf-8"?>\n<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="uid" version="2.0">\n  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">\n    <dc:title>${escapeXml(title)}</dc:title>\n    <dc:creator>${escapeXml(author)}</dc:creator>\n    <dc:identifier id="uid">${uid}</dc:identifier>\n    <dc:language>en</dc:language>\n  </metadata>\n  <manifest>\n    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>\n    ${manifestItems.join('\n    ')}\n  </manifest>\n  <spine toc="ncx">\n    ${spineItems.join('\n    ')}\n  </spine>\n</package>`;
      zip.file('OEBPS/content.opf', contentOpf);

      // toc.ncx
      const navPoints = pages.map((p, idx) => `    <navPoint id="navPoint-${idx+1}" playOrder="${idx+1}">\n      <navLabel><text>Page ${p.page}</text></navLabel>\n      <content src="page-${p.page}.xhtml"/>\n    </navPoint>`).join('\n');
      const toc = `<?xml version="1.0" encoding="utf-8"?>\n<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">\n  <head>\n    <meta name="dtb:uid" content="${uid}"/>\n  </head>\n  <docTitle><text>${escapeXml(title)}</text></docTitle>\n  <navMap>\n${navPoints}\n  </navMap>\n</ncx>`;
      zip.file('OEBPS/toc.ncx', toc);

      return zip;
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/\n/g,' '); }
    function escapeXml(s){ return escapeHtml(s); }

    buildEpubBtn.addEventListener('click', async ()=>{
      const file = pdfFile.files[0];
      if(!file) return alert('Please select a PDF first');
      const title = titleEl.value || file.name.replace(/\.[^.]+$/,'');
      const author = authorEl.value || 'Unknown';
      preview.textContent = 'Extracting text from PDF...';
      try{
        const ab = await file.arrayBuffer();
        const pages = await extractPdfText(ab);
        extractedTextByPage = pages;
        preview.textContent = `Extracted ${pages.length} pages. Building EPUB...`;
        const zip = makeEpubStructure({title,author}, pages);
        const content = await zip.generateAsync({type:'blob', mimeType:'application/epub+zip'});
        lastEpubBlob = content;
        preview.textContent = `EPUB built. Click Download EPUB to save. (${(content.size/1024).toFixed(1)} KB)`;
      }catch(err){ console.error(err); preview.textContent = 'Failed: '+err.message; }
    });

    previewTextBtn.addEventListener('click', ()=>{
      if(!extractedTextByPage) return alert('No extracted text — run Build EPUB first');
      preview.textContent = extractedTextByPage.map(p=>`--- Page ${p.page} ---\n${p.text}`).join('\n\n').slice(0,20000) + (extractedTextByPage.join ? '\n\n...(truncated)' : '');
    });

    downloadEpubBtn.addEventListener('click', ()=>{
      if(!lastEpubBlob) return alert('No EPUB available. Build EPUB first');
      const a = document.createElement('a');
      const url = URL.createObjectURL(lastEpubBlob);
      a.href = url; a.download = (titleEl.value || 'converted') + '.epub';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    openEpubBtn.addEventListener('click', ()=>{
      if(!lastEpubBlob) return alert('No EPUB available. Build EPUB first');
      const url = URL.createObjectURL(lastEpubBlob);
      window.open(url,'_blank'); setTimeout(()=>URL.revokeObjectURL(url),2000);
    });

    clearBtn.addEventListener('click', ()=>{ pdfFile.value=''; titleEl.value=''; authorEl.value=''; preview.textContent=''; lastEpubBlob=null; extractedTextByPage=null; });

    // Optional: placeholder for server-side MOBI conversion
    async function convertEpubToMobiServerSide(epubBlob){
      // Send epubBlob to your server which runs Calibre / kindlegen and returns MOBI
      // Example (not implemented):
      // const fd = new FormData(); fd.append('file', epubBlob, 'book.epub');
      // const res = await fetch('/api/convert/epub-to-mobi', {method:'POST', body:fd});
      // return res.blob();
      return null;
    }
  </script>
</body>
</html>
