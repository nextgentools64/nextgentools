<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Task Manager (Full CRUD & Filtering)</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="A powerful, persistent to-do list and task manager with priority, due dates, and real-time data synchronization using Firestore.">
    <meta name="keywords" content="todo list, task manager, firebase, firestore, javascript, html, responsive">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind for Inter font and clean styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .task-item {
            transition: all 0.2s;
        }
        .completed .task-text, .completed .task-date {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .edit-input {
            width: 100%;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            outline: none;
            font-weight: 500;
            color: #1f2937;
        }
        /* Custom checkbox style */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #6366f1;
            border-radius: 0.375rem;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        input[type="checkbox"]:checked {
            background-color: #6366f1;
            border-color: #6366f1;
        }
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-12 pb-12">

    <div class="w-full max-w-2xl mx-4">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Persistent Task Manager</h1>
            <p id="userIdDisplay" class="text-xs text-indigo-500 font-medium tracking-wide">
                User ID: Loading...
            </p>
        </header>

        <!-- New Task Input Form -->
        <form id="newTaskForm" class="p-4 bg-white shadow-xl rounded-xl mb-8 border border-indigo-100">
            <div class="mb-4">
                <input 
                    type="text" 
                    id="taskInput" 
                    placeholder="What needs to be done?" 
                    class="w-full p-3 text-lg text-gray-700 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    required
                >
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 items-center">
                
                <!-- Priority Dropdown -->
                <div class="w-full sm:w-1/3">
                    <label for="priorityInput" class="block text-xs font-medium text-gray-500 mb-1">Priority</label>
                    <select id="priorityInput" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                
                <!-- Due Date Picker -->
                <div class="w-full sm:w-1/3">
                    <label for="dueDateInput" class="block text-xs font-medium text-gray-500 mb-1">Due Date</label>
                    <input type="date" id="dueDateInput" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>

                <!-- Add Button -->
                <button 
                    type="submit" 
                    class="w-full sm:w-1/3 mt-4 sm:mt-auto bg-indigo-600 text-white p-2.5 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold flex items-center justify-center space-x-2 shadow-md hover:shadow-lg"
                    aria-label="Add Task"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    <span>Create Task</span>
                </button>
            </div>
        </form>

        <!-- Filtering and Sorting Controls -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-md border border-gray-200 gap-3">
            <!-- Status Filter -->
            <div class="w-full sm:w-auto">
                <label for="statusFilter" class="sr-only">Filter by Status</label>
                <select id="statusFilter" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white">
                    <option value="All">Show All Tasks</option>
                    <option value="Active">Show Active Only</option>
                    <option value="Completed">Show Completed Only</option>
                </select>
            </div>

            <!-- Priority Filter -->
            <div class="w-full sm:w-auto">
                <label for="priorityFilter" class="sr-only">Filter by Priority</label>
                <select id="priorityFilter" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white">
                    <option value="All">Filter by Priority (All)</option>
                    <option value="High">High Priority</option>
                    <option value="Medium">Medium Priority</option>
                    <option value="Low">Low Priority</option>
                </select>
            </div>
        </div>

        <!-- Task List Container -->
        <div id="taskListContainer" class="bg-white rounded-xl shadow-2xl p-6 space-y-4 border border-indigo-200">
            <div id="loadingIndicator" class="text-center py-8 text-gray-500">
                <p>Connecting to database and fetching tasks...</p>
            </div>
            <p id="emptyMessage" class="hidden text-center text-gray-400 py-8">
                Awesome! You have no tasks matching the current filters.
            </p>
            <ul id="taskList" class="space-y-3">
                <!-- Tasks will be inserted here by JavaScript -->
            </ul>
        </div>

        <!-- DETAILS & FAQs SECTION -->
        <div class="mt-12 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Key Features and How it Works</h2>
            <p class="text-gray-600 mb-6">This task manager is designed to be fully functional and persistent across sessions, leveraging cloud technology to secure your data.</p>
            
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Core Features:</h3>
            <ul class="list-disc list-inside space-y-2 text-gray-600 ml-4">
                <li><strong class="text-indigo-600">Persistence (Firestore)</strong>: All your tasks, including their status, priority, and due dates, are saved instantly to a secure Firebase Firestore database. They remain available even if you close your browser.</li>
                <li><strong class="text-indigo-600">Full CRUD</strong>: You can Create, Read, Update (inline editing), and Delete tasks (Full CRUD functionality).</li>
                <li><strong class="text-indigo-600">Smart Sorting</strong>: Active tasks are automatically sorted by the closest **Due Date** first, and then by **Priority** (High, Medium, Low). Completed tasks are always pushed to the bottom.</li>
                <li><strong class="text-indigo-600">Advanced Filtering</strong>: Easily filter tasks by their completion **Status** (Active, Completed, All) and their **Priority** level.</li>
                <li><strong class="text-indigo-600">Anonymous Security</strong>: You are automatically signed in anonymously using a unique ID, ensuring your tasks are private and linked only to your current session/environment.</li>
            </ul>

            <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-3 border-t pt-4">Frequently Asked Questions (FAQs)</h3>
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-gray-800">1. How is my data saved?</h4>
                    <p class="text-sm text-gray-600">Your data is saved to a dedicated **Google Firestore** database. This provides real-time syncing, meaning if you update a task, the change is saved instantly and securely. Your data is stored under the unique User ID shown at the top of the page.</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">2. How do I edit a task?</h4>
                    <p class="text-sm text-gray-600">To edit a task's text, simply **click on the task description**. The text will turn into an input field. Type your changes and press **Enter** or click anywhere else on the screen to save the update instantly to the database.</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-800">3. Why is sorting important?</h4>
                    <p class="text-sm text-gray-600">The smart sorting ensures that tasks requiring your immediate attention (those with the closest due dates and highest priority) are always at the top of the list, helping you focus on what matters most.</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase Configuration and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, collection, query, where, orderBy, 
            addDoc, setDoc, deleteDoc, onSnapshot, updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL ENVIRONMENT VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INSTANCES & STATE ---
        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let allTasks = []; // Holds the unfiltered data from Firestore

        // --- FILTER STATE ---
        let currentStatusFilter = 'All';
        let currentPriorityFilter = 'All';

        // --- DOM ELEMENTS ---
        const taskList = document.getElementById('taskList');
        const taskInput = document.getElementById('taskInput');
        const priorityInput = document.getElementById('priorityInput');
        const dueDateInput = document.getElementById('dueDateInput');
        const newTaskForm = document.getElementById('newTaskForm');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyMessage = document.getElementById('emptyMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const statusFilter = document.getElementById('statusFilter');
        const priorityFilter = document.getElementById('priorityFilter');
        
        // Priority to Integer mapping for custom in-memory sorting
        const PRIORITY_MAP = { 'High': 3, 'Medium': 2, 'Low': 1 };
        const PRIORITY_COLORS = { 
            'High': { bg: 'bg-red-500', text: 'text-red-500' }, 
            'Medium': { bg: 'bg-yellow-500', text: 'text-yellow-500' }, 
            'Low': { bg: 'bg-green-500', text: 'text-green-500' } 
        };

        // --- FIREBASE INITIALIZATION AND AUTH ---

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                isAuthReady = true;
                
                userIdDisplay.textContent = `User ID: ${userId}`;
                newTaskForm.querySelector('button').disabled = false;

                setupRealtimeListener();

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                loadingIndicator.textContent = "Could not connect to database. Try reloading.";
            }
        }

        /**
         * Returns the reference to the user's private task collection.
         */
        function getTaskCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, 'artifacts', appId, 'users', userId, 'task_manager');
        }

        // --- CRUD OPERATIONS ---

        /**
         * Sets up the real-time Firestore listener (onSnapshot).
         */
        function setupRealtimeListener() {
            const tasksRef = getTaskCollectionRef();
            if (!tasksRef) return;
            
            // NOTE: We only order by createdAt to ensure consistent initial list structure,
            // but the primary sorting (by completion/priority/date) is handled in client-side JS.
            const q = query(tasksRef, orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                allTasks = [];
                snapshot.forEach(doc => {
                    allTasks.push({ id: doc.id, ...doc.data() });
                });
                applyFiltersAndSort(); // Trigger filtering and sorting upon data update
            }, (error) => {
                console.error("Firestore real-time listener failed:", error);
                loadingIndicator.textContent = "Error loading tasks in real-time.";
            });
        }

        /**
         * Adds a new task to Firestore.
         */
        async function addTask(text, priority, dueDate) {
            if (!isAuthReady) return;
            try {
                await addDoc(getTaskCollectionRef(), {
                    text: text.trim(),
                    completed: false,
                    priority: priority,
                    dueDate: dueDate || null, // Store as null if empty
                    createdAt: Date.now()
                });
                taskInput.value = ''; // Clear input on success
                dueDateInput.value = '';
                priorityInput.value = 'Medium';
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        /**
         * Toggles the completion status of a task.
         */
        async function toggleTask(id, completed) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(getTaskCollectionRef(), id);
                await updateDoc(docRef, { completed: !completed });
            } catch (e) {
                console.error("Error toggling task: ", e);
            }
        }

        /**
         * Updates the text content of a task.
         */
        async function updateTaskText(id, newText) {
             if (!isAuthReady || !newText.trim()) return;
            try {
                const docRef = doc(getTaskCollectionRef(), id);
                await updateDoc(docRef, { text: newText.trim() });
            } catch (e) {
                console.error("Error updating task: ", e);
            }
        }

        /**
         * Deletes a task from Firestore.
         */
        async function deleteTask(id) {
            if (!isAuthReady) return;
            try {
                const docRef = doc(getTaskCollectionRef(), id);
                await deleteDoc(docRef);
            } catch (e) {
                console.error("Error deleting task: ", e);
            }
        }

        // --- FILTERING AND SORTING LOGIC ---

        function applyFiltersAndSort() {
            // 1. Filter
            let filteredTasks = allTasks.filter(task => {
                // Status Filter
                const statusMatch = (currentStatusFilter === 'All') ||
                                    (currentStatusFilter === 'Active' && !task.completed) ||
                                    (currentStatusFilter === 'Completed' && task.completed);
                
                // Priority Filter
                const priorityMatch = (currentPriorityFilter === 'All') || (currentPriorityFilter === task.priority);

                return statusMatch && priorityMatch;
            });

            // 2. Sort
            filteredTasks.sort((a, b) => {
                // Completed tasks always go to the bottom
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1; 
                }

                // If both are active, sort by Due Date (closest first)
                if (!a.completed && !b.completed) {
                    // Treat null/empty due date as latest (Infinity)
                    const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                    const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                    
                    if (dateA !== dateB) {
                        return dateA - dateB; // Closer date comes first
                    }
                    
                    // If Due Dates are the same, sort by Priority (High first)
                    const priorityA = PRIORITY_MAP[a.priority] || 0;
                    const priorityB = PRIORITY_MAP[b.priority] || 0;
                    return priorityB - priorityA; // Higher number (priority) comes first
                }
                
                // If both are completed, just keep the creation order
                return 0; 
            });

            renderTasks(filteredTasks);
        }

        // --- UI RENDERING ---

        /**
         * Renders the list of tasks to the DOM.
         */
        function renderTasks(tasks) {
            taskList.innerHTML = ''; // Clear current list
            loadingIndicator.classList.add('hidden');
            
            if (tasks.length === 0) {
                emptyMessage.classList.remove('hidden');
            } else {
                emptyMessage.classList.add('hidden');
                
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = `task-item flex items-start p-4 rounded-xl shadow-lg border ${task.completed ? 'completed bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:shadow-xl'}`;
                    li.dataset.id = task.id;

                    const priorityColor = PRIORITY_COLORS[task.priority] || PRIORITY_COLORS['Medium'];
                    const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate).getTime() < new Date().setHours(0, 0, 0, 0);

                    // Checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = task.completed;
                    checkbox.className = 'mr-4 mt-1';
                    checkbox.addEventListener('change', () => toggleTask(task.id, task.completed));

                    // Task Content and Metadata
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'flex-grow min-w-0';

                    // Task Text (Editable)
                    const taskTextEl = document.createElement('span');
                    taskTextEl.className = 'task-text text-base font-medium text-gray-800 break-words cursor-pointer block';
                    taskTextEl.textContent = task.text;
                    
                    // Inline Editing Listener
                    taskTextEl.addEventListener('click', (e) => startEditing(e, task.id, task.text));


                    // Metadata (Priority and Due Date)
                    const metadataContainer = document.createElement('div');
                    metadataContainer.className = 'flex items-center mt-1 text-xs space-x-3';
                    
                    // Priority Badge
                    const priorityBadge = document.createElement('span');
                    priorityBadge.className = `font-bold px-2 py-0.5 rounded-full ${priorityColor.bg} text-white`;
                    priorityBadge.textContent = task.priority.toUpperCase();

                    // Due Date
                    const dueDateText = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No Due Date';
                    const dueDateEl = document.createElement('span');
                    dueDateEl.className = `task-date font-semibold ${isOverdue ? 'text-red-600' : 'text-gray-500'}`;
                    dueDateEl.innerHTML = `<svg class="w-4 h-4 inline mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>${isOverdue ? 'OVERDUE: ' : ''}${dueDateText}`;
                    
                    metadataContainer.appendChild(priorityBadge);
                    metadataContainer.appendChild(dueDateEl);
                    
                    contentContainer.appendChild(taskTextEl);
                    contentContainer.appendChild(metadataContainer);

                    // Delete Button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'flex-shrink-0 ml-4 p-1 rounded-full text-gray-400 hover:text-red-600 hover:bg-red-100 transition duration-150 mt-1';
                    deleteBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                    deleteBtn.setAttribute('aria-label', `Delete task: ${task.text}`);
                    deleteBtn.addEventListener('click', () => deleteTask(task.id));

                    li.appendChild(checkbox);
                    li.appendChild(contentContainer);
                    li.appendChild(deleteBtn);
                    taskList.appendChild(li);
                });
            }
        }

        /**
         * Replaces the task text span with an editable input field.
         */
        function startEditing(event, taskId, currentText) {
            const taskTextEl = event.currentTarget;
            
            // Prevent editing if already completed
            if (taskTextEl.closest('.completed')) return;
            
            const contentContainer = taskTextEl.parentElement;

            // Create the input element
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'edit-input';
            input.value = currentText;
            input.autofocus = true;

            // Replace span with input
            contentContainer.replaceChild(input, taskTextEl);
            input.focus();

            // Function to save and revert
            const finishEditing = () => {
                const newText = input.value.trim();
                if (newText && newText !== currentText) {
                    updateTaskText(taskId, newText);
                }
                
                // Revert to span regardless of save success
                taskTextEl.textContent = newText || currentText; // Update text immediately
                contentContainer.replaceChild(taskTextEl, input);
            };

            // Event Listeners for input
            input.addEventListener('blur', finishEditing);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission if in form
                    finishEditing();
                } else if (e.key === 'Escape') {
                    // Revert without saving
                    input.value = currentText; 
                    finishEditing();
                }
            });
        }


        // --- EVENT LISTENERS ---

        newTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = taskInput.value.trim();
            const priority = priorityInput.value;
            const dueDate = dueDateInput.value;

            if (text) {
                addTask(text, priority, dueDate);
            }
        });

        statusFilter.addEventListener('change', (e) => {
            currentStatusFilter = e.target.value;
            applyFiltersAndSort();
        });

        priorityFilter.addEventListener('change', (e) => {
            currentPriorityFilter = e.target.value;
            applyFiltersAndSort();
        });

        // Initialize Firebase on load
        window.onload = initializeFirebase;
    </script>
</body>
</html>