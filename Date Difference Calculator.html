<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SEO Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoreDropship.in | Persistent Date Difference Calculator with Custom Work Week</title>
    <meta name="description" content="Calculate the difference between two dates, including working day counts based on a custom, user-defined work week and persistent holiday exclusion via Firestore, with report download functionality.">
    <meta name="keywords" content="date calculator, date difference, working days, custom work week, custom holidays, Firestore, StoreDropship, download report">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configure Tailwind for Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc; /* Light background */
        }
        /* Custom styling for inputs */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); 
        }
        /* Spinner CSS for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Header -->
    <header class="bg-indigo-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-wider">StoreDropship.in</h1>
            <p class="text-sm italic opacity-80 hidden sm:block">Advanced Time Tools</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 md:py-12">
        <div class="max-w-4xl mx-auto">
            
            <!-- Calculation Card -->
            <div class="bg-white rounded-xl shadow-2xl p-6 md:p-10 mb-10">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-3">Date Range Analyzer</h2>
                <p class="text-gray-600 mb-8">Select two dates and configure your working days and custom holidays below.</p>

                <!-- Input Controls -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="startDate" value="" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50 text-gray-800" aria-label="Start Date Picker">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" id="endDate" value="" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-50 text-gray-800" aria-label="End Date Picker">
                    </div>
                </div>

                <!-- Working Week and Options Group -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    
                    <!-- Working Week Configuration -->
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <h4 class="block text-sm font-medium text-gray-900 mb-3">
                            Working Week Configuration
                            <span class="text-xs text-gray-600 block font-normal mt-1">Select the days that count as working days (Saved to Firestore).</span>
                        </h4>
                        <div id="workingWeekCheckboxes" class="flex flex-wrap justify-between text-center gap-2">
                            <!-- Checkboxes will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200 flex flex-col justify-center">
                        <div class="flex items-center">
                            <input type="checkbox" id="inclusiveToggle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked aria-checked="true" aria-describedby="inclusiveHelp">
                            <label for="inclusiveToggle" class="ml-2 block text-sm text-gray-900 font-medium">
                                Inclusive Calculation
                            </label>
                        </div>
                        <p id="inclusiveHelp" class="text-xs text-gray-500 mt-1 ml-6">When checked, counts both the Start Day and the End Day.</p>
                    </div>

                </div>

                <!-- Custom Holidays Input (Persistent via Firestore) -->
                <div class="mb-8 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label for="customHolidays" class="block text-sm font-medium text-gray-900 mb-2 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-yellow-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                        Custom Holidays (One Date per Line)
                        <span id="holidayStatus" class="ml-auto text-xs font-normal text-yellow-700 flex items-center">
                            <span class="spinner mr-2"></span>
                            Loading...
                        </span>
                    </label>
                    <textarea id="customHolidays" rows="3" placeholder="YYYY-MM-DD (e.g., 2025-01-01)&#10;2025-03-20" class="w-full p-2 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150 text-sm" aria-label="Custom Holidays List" disabled></textarea>
                    <p class="text-xs text-gray-600 mt-1">These dates will be excluded from the working day count (Saved to your private Firestore data).</p>
                </div>

                <!-- Results Display Area -->
                <div id="resultsArea" class="mt-8 border-t pt-6 hidden" aria-live="polite">
                    <h3 class="text-2xl font-bold text-indigo-700 mb-4">Calculation Results</h3>

                    <!-- Human Readable Breakdown -->
                    <div class="mb-6 p-4 bg-indigo-100 rounded-lg shadow-inner">
                        <h4 class="text-lg font-semibold text-indigo-800 mb-2">Total Time Elapsed (Approximate)</h4>
                        <p id="humanResult" class="text-xl font-extrabold text-indigo-900"></p>
                    </div>
                    
                    <!-- Detailed Metrics -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
                            <p class="text-xs font-semibold uppercase text-gray-500">Total Days</p>
                            <p id="totalDays" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
                            <p class="text-xs font-semibold uppercase text-gray-500">Approx. Weeks</p>
                            <p id="totalWeeks" class="text-2xl font-bold text-gray-800 mt-1">0.0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
                            <p class="text-xs font-semibold uppercase text-gray-500">Working Days <span id="workingDayLabel"></span></p>
                            <p id="workingDays" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
                            <p class="text-xs font-semibold uppercase text-gray-500">Calendar Months</p>
                            <p id="calendarMonths" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                        </div>
                    </div>

                    <p id="errorMsg" class="text-red-600 font-medium mt-4 hidden"></p>

                    <!-- Download Button -->
                    <button id="downloadReportBtn" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 flex items-center shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download Report (.txt)
                    </button>
                </div>
            </div>
            
            <!-- Details Section -->
            <div class="bg-white rounded-xl shadow-xl p-6 md:p-10 mb-10">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-4 border-b pb-2">How the Calculations Work</h3>
                <p class="text-gray-600 mb-6">We use precise, client-side JavaScript to determine the difference, ensuring accurate results for various metrics.</p>
                
                <div class="space-y-4">
                    <h4 class="font-semibold text-indigo-700">Total Days & Weeks</h4>
                    <p class="text-sm text-gray-700">Calculated by finding the exact time difference in milliseconds between the two dates and dividing by the milliseconds in a day. The calculator accounts for Daylight Saving Time (DST) changes and uses **rounding** to ensure a whole number of days. Weeks are derived directly from the total days (Total Days / 7).</p>
                    
                    <h4 class="font-semibold text-indigo-700">Custom Working Days & Holidays</h4>
                    <p class="text-sm text-gray-700">The **Working Days** count is now based entirely on your selections in the **Working Week Configuration**. It excludes any days that are unchecked *and* any dates you manually enter in the Custom Holidays list. Both your custom week and holidays are saved to **Firestore**.</p>
                    
                    <h4 class="font-semibold text-indigo-700">Calendar Months & Years</h4>
                    <p class="text-sm text-gray-700">These values provide a **human-friendly approximation** based on calendar-to-calendar difference (e.g., Nov 10, 2025 to Nov 10, 2026 is exactly 1 year). The breakdown shows the remaining days, months, and full years remaining when calculating from the start date to the end date.</p>
                </div>
            </div>

            <!-- FAQs Section -->
            <div class="bg-white rounded-xl shadow-xl p-6 md:p-10">
                <h3 class="text-2xl font-extrabold text-gray-800 mb-4 border-b pb-2">Frequently Asked Questions (FAQs)</h3>
                
                <div class="space-y-6">
                    <div>
                        <h4 class="font-semibold text-gray-900">Q: How are my custom settings saved?</h4>
                        <p class="text-sm text-gray-700 mt-1">A: Both the selected working week days and your custom holidays are securely saved to your unique user ID using **Firestore** for persistence.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">Q: How do I download the results?</h4>
                        <p class="text-sm text-gray-700 mt-1">A: Click the "Download Report" button to generate a clean, plain text file containing all the key metrics, including the input dates and configuration details.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900">Q: What is the day numbering for the working week?</h4>
                        <p class="text-sm text-gray-700 mt-1">A: The underlying JavaScript uses Sunday=0, Monday=1, up to Saturday=6. The checkboxes reflect these days directly.</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-auto">
        <div class="container mx-auto px-4 py-6 text-center">
            <p class="text-sm mb-2">&copy; 2025 StoreDropship.in | All Rights Reserved.</p>
            <p class="text-xs">Contact us: 
                <span class="font-medium mr-3">+91 9258036351</span> | 
                <span class="font-medium">contact@storedropship.in</span>
            </p>
        </div>
    </footer>

    <!-- Client-Side JavaScript Logic with Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase Instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Debouncing for Firestore updates
        let saveTimer = null;
        const SAVE_DELAY_MS = 1000;

        // CONSTANTS
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const WEEK_DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // DOM elements
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const inclusiveToggle = document.getElementById('inclusiveToggle');
        const customHolidaysInput = document.getElementById('customHolidays');
        const resultsArea = document.getElementById('resultsArea');
        const holidayStatusEl = document.getElementById('holidayStatus');
        const spinnerEl = holidayStatusEl.querySelector('.spinner');
        const workingWeekCheckboxesContainer = document.getElementById('workingWeekCheckboxes');
        const downloadReportBtn = document.getElementById('downloadReportBtn');

        // State to hold custom configuration (default is Mon-Fri: 1, 2, 3, 4, 5)
        let workingDaysIndices = [1, 2, 3, 4, 5]; 
        
        // Global storage for the latest calculation results for the report
        let calculationData = {}; 

        // --- UI RENDER FUNCTIONS ---
        
        /**
         * Renders the 7 working day checkboxes and sets their initial state.
         */
        function renderWorkingWeekCheckboxes() {
            workingWeekCheckboxesContainer.innerHTML = '';
            WEEK_DAYS.forEach((dayName, dayIndex) => {
                const isChecked = workingDaysIndices.includes(dayIndex);
                
                const label = document.createElement('label');
                label.className = 'flex flex-col items-center cursor-pointer p-2 rounded-lg transition duration-150';
                label.style.backgroundColor = isChecked ? '#e0e7ff' : '#f3f4f6';
                label.style.color = isChecked ? '#4f46e5' : '#4b5563';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'hidden';
                checkbox.checked = isChecked;
                checkbox.dataset.dayIndex = dayIndex;

                const dayText = document.createElement('span');
                dayText.className = 'text-xs font-semibold';
                dayText.textContent = dayName;

                label.appendChild(checkbox);
                label.appendChild(dayText);
                workingWeekCheckboxesContainer.appendChild(label);
                
                checkbox.addEventListener('change', handleWorkingWeekChange);
            });
        }
        
        /**
         * Handles change events on the working week checkboxes.
         */
        function handleWorkingWeekChange(event) {
            const checkbox = event.target;
            const dayIndex = parseInt(checkbox.dataset.dayIndex);
            
            // Update the global state
            if (checkbox.checked) {
                if (!workingDaysIndices.includes(dayIndex)) {
                    workingDaysIndices.push(dayIndex);
                    workingDaysIndices.sort((a, b) => a - b);
                }
            } else {
                workingDaysIndices = workingDaysIndices.filter(index => index !== dayIndex);
            }
            
            // Update UI color immediately
            const label = checkbox.closest('label');
            label.style.backgroundColor = checkbox.checked ? '#e0e7ff' : '#f3f4f6';
            label.style.color = checkbox.checked ? '#4f46e5' : '#4b5563';

            // Trigger calculation and save
            calculateDifference();
            saveSettingsDebounced();
        }

        // --- FIREBASE SETUP FUNCTIONS ---

        /**
         * Initializes Firebase and authenticates the user sequentially.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid || crypto.randomUUID();
                isAuthReady = true;
                
                await loadSettings();

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                
                userId = crypto.randomUUID();
                isAuthReady = true;
                
                customHolidaysInput.disabled = false;
                spinnerEl.classList.add('hidden');
                holidayStatusEl.textContent = "Offline Mode (Persistence Disabled)";
                renderWorkingWeekCheckboxes(); // Render defaults
                calculateDifference(); 
            }
        }

        /**
         * Path to the user's private settings document.
         */
        function getSettingsDocRef() {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'calculator_settings', 'settings');
        }

        /**
         * Loads saved custom settings (holidays and working week) from Firestore.
         */
        async function loadSettings() {
            const docRef = getSettingsDocRef();
            if (!docRef) {
                holidayStatusEl.textContent = "Error: DB not ready.";
                return;
            }

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.holidayList) {
                        customHolidaysInput.value = data.holidayList;
                    }
                    if (Array.isArray(data.workingDaysIndices)) {
                        workingDaysIndices = data.workingDaysIndices;
                    }

                    holidayStatusEl.textContent = "Settings loaded.";

                } else {
                    holidayStatusEl.textContent = "Ready (New config).";
                }
            } catch (e) {
                console.error("Error loading settings:", e);
                holidayStatusEl.textContent = "Load Error.";
            } finally {
                spinnerEl.classList.add('hidden');
                customHolidaysInput.disabled = false;
                renderWorkingWeekCheckboxes(); 
                calculateDifference(); 
            }
        }

        /**
         * Saves custom settings to Firestore with debouncing.
         */
        function saveSettingsDebounced() {
            if (!isAuthReady || !db) return;
            
            clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                await saveSettings();
            }, SAVE_DELAY_MS);
        }

        /**
         * Saves the custom settings to Firestore.
         */
        async function saveSettings() {
            const docRef = getSettingsDocRef();
            if (!docRef) return;
            
            holidayStatusEl.textContent = "Saving...";
            
            try {
                await setDoc(docRef, {
                    holidayList: customHolidaysInput.value,
                    workingDaysIndices: workingDaysIndices
                });
                holidayStatusEl.textContent = "Saved!";
            } catch (e) {
                console.error("Error saving settings:", e);
                holidayStatusEl.textContent = "Save Error.";
            }
            
            setTimeout(() => {
                if (holidayStatusEl.textContent.includes('Save')) {
                    holidayStatusEl.textContent = "Ready.";
                }
            }, 3000);
        }

        // --- CALCULATION UTILITIES ---
        
        function formatUnit(value, unit) {
            return `${value} ${unit}${value !== 1 ? 's' : ''}`;
        }

        function parseHolidays() {
            const holidaysText = customHolidaysInput.value;
            const dateRegex = /(\d{4}-\d{2}-\d{2})/; 
            const holidaySet = new Set();
            
            holidaysText.split('\n').forEach(line => {
                const match = line.trim().match(dateRegex);
                if (match) {
                    holidaySet.add(match[1]);
                }
            });
            return holidaySet;
        }
        
        function calculateWorkingDays(start, end, holidaySet) {
            let count = 0;
            let currentDate = new Date(start.getTime());
            
            const workingDaysSet = new Set(workingDaysIndices);

            while (currentDate.getTime() <= end.getTime()) {
                const day = currentDate.getDay(); 
                const dateString = currentDate.toISOString().split('T')[0];

                const isCustomWorkingDay = workingDaysSet.has(day);
                const isHoliday = holidaySet.has(dateString);

                if (isCustomWorkingDay && !isHoliday) {
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count; 
        }

        function calculateCalendarBreakdown(start, end) {
            const startDate = new Date(start.getTime());
            const endDate = new Date(end.getTime());
            
            let years = endDate.getFullYear() - startDate.getFullYear();
            let months = endDate.getMonth() - startDate.getMonth();
            let days = endDate.getDate() - startDate.getDate();

            if (days < 0) {
                months--;
                const previousMonthEnd = new Date(endDate.getFullYear(), endDate.getMonth(), 0);
                days += previousMonthEnd.getDate();
            }

            if (months < 0) {
                years--;
                months += 12;
            }

            return { years, months, days };
        }

        /**
         * Main function to handle input reading and calculations.
         */
        function calculateDifference() {
            const startStr = startDateInput.value;
            const endStr = endDateInput.value;
            const isInclusive = inclusiveToggle.checked;
            
            if (!isAuthReady || !startStr || !endStr || customHolidaysInput.disabled) {
                 resultsArea.classList.add('hidden');
                 return;
            }

            // UI references
            const elements = {
                errorMsgEl: document.getElementById('errorMsg'),
                resultsArea: document.getElementById('resultsArea'),
                totalDaysEl: document.getElementById('totalDays'),
                totalWeeksEl: document.getElementById('totalWeeks'),
                workingDaysEl: document.getElementById('workingDays'),
                calendarMonthsEl: document.getElementById('calendarMonths'),
                humanResult: document.getElementById('humanResult'),
                workingDayLabel: document.getElementById('workingDayLabel')
            };

            elements.resultsArea.classList.add('hidden');
            elements.errorMsgEl.classList.add('hidden');
            
            let startDate = new Date(startStr);
            let endDate = new Date(endStr);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                elements.errorMsgEl.textContent = "Please enter two valid dates.";
                elements.errorMsgEl.classList.remove('hidden');
                return;
            }
            
            let finalStart = startDate.getTime() <= endDate.getTime() ? startDate : endDate;
            let finalEnd = startDate.getTime() <= endDate.getTime() ? endDate : startDate;
            
            // 1. Total Days
            let timeDiff = finalEnd.getTime() - finalStart.getTime();
            let totalDays = Math.round(timeDiff / MS_PER_DAY); 

            if (isInclusive) {
                 totalDays += 1;
            }

            // 2. Working Day Calculations
            const holidaySet = parseHolidays();
            const workingDaysCount = calculateWorkingDays(finalStart, finalEnd, holidaySet);

            // 3. Other Metrics
            const totalWeeks = (totalDays / 7).toFixed(1);
            const breakdown = calculateCalendarBreakdown(finalStart, finalEnd);
            const totalCalendarMonths = breakdown.years * 12 + breakdown.months;
            
            const workingDayNames = workingDaysIndices.map(index => WEEK_DAYS[index]).join(', ');
            const holidayCount = holidaySet.size;
            
            let labelText = `(${workingDayNames})`;
            if (holidayCount > 0) {
                labelText += ` - ${holidayCount} Holiday${holidayCount !== 1 ? 's' : ''}`;
            }
            elements.workingDayLabel.textContent = labelText;

            // 4. Human-Friendly Result String
            const parts = [];
            if (breakdown.years > 0) parts.push(formatUnit(breakdown.years, 'year'));
            if (breakdown.months > 0) parts.push(formatUnit(breakdown.months, 'month'));
            if (breakdown.days > 0 || (breakdown.years === 0 && breakdown.months === 0 && totalDays !== 0)) {
                parts.push(formatUnit(breakdown.days, 'day'));
            }
            const humanString = parts.length > 0 ? parts.join(', ') : (totalDays === 0 ? formatUnit(0, 'day') : formatUnit(totalDays, 'day'));

            // 5. Store data globally and Update DOM
            calculationData = {
                start: startStr,
                end: endStr,
                inclusive: isInclusive,
                totalDays: totalDays,
                totalWeeks: totalWeeks,
                workingDaysCount: workingDaysCount,
                workingDaysList: workingDayNames,
                holidayCount: holidayCount,
                calendarMonths: totalCalendarMonths,
                humanResult: humanString,
                holidays: customHolidaysInput.value.trim().split('\n').filter(h => h).join(', ')
            };

            elements.totalDaysEl.textContent = totalDays.toLocaleString();
            elements.totalWeeksEl.textContent = totalWeeks;
            elements.workingDaysEl.textContent = workingDaysCount.toLocaleString();
            elements.calendarMonthsEl.textContent = totalCalendarMonths.toLocaleString();
            elements.humanResult.textContent = humanString;
            
            elements.resultsArea.classList.remove('hidden');
        }


        // --- REPORT DOWNLOAD FUNCTION ---

        function generateReport() {
            if (resultsArea.classList.contains('hidden')) {
                // Use a custom modal in a real app, but for this constraint:
                console.error("No calculation results available to download.");
                return;
            }
            
            const now = new Date().toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });

            const reportContent = `
Date Difference Calculation Report
Generated by StoreDropship.in Calculator
Timestamp: ${now}
--------------------------------------------------

--- INPUT CONFIGURATION ---
Start Date: ${calculationData.start}
End Date: ${calculationData.end}
Calculation Mode: ${calculationData.inclusive ? 'Inclusive (Start and End days counted)' : 'Exclusive (Elapsed days only)'}

Working Week: ${calculationData.workingDaysList}
Custom Holidays Excluded: ${calculationData.holidayCount}
Holiday List: ${calculationData.holidays || 'None'}

--------------------------------------------------

--- RESULTS ---
Total Time Elapsed: ${calculationData.humanResult}
    (Equivalent to ${calculationData.calendarMonths} approximate calendar months)

Detailed Metrics:
Total Days: ${calculationData.totalDays.toLocaleString()}
Approx. Weeks: ${calculationData.totalWeeks}
Working Days (Adjusted): ${calculationData.workingDaysCount.toLocaleString()}

--------------------------------------------------
`;
            // Create a Blob and trigger download
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `Date_Report_${calculationData.start}_to_${calculationData.end}.txt`;
            
            // Append to body, click, and remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        function setupListeners() {
            const today = new Date().toISOString().split('T')[0];
            startDateInput.value = today;
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            endDateInput.value = nextMonth.toISOString().split('T')[0];
            
            startDateInput.addEventListener('change', calculateDifference);
            endDateInput.addEventListener('change', calculateDifference);
            inclusiveToggle.addEventListener('change', calculateDifference);
            downloadReportBtn.addEventListener('click', generateReport);
            
            customHolidaysInput.addEventListener('input', () => {
                calculateDifference(); 
                saveSettingsDebounced();
            });
        }
        
        window.onload = function() {
            setupListeners();
            initializeFirebase();
        };

    </script>

</body>
</html>