<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Compressor Pro</title>
  <style>
    :root{--bg:#f9f9f9;--card:#fff;--accent:#28a745;--accent-dark:#1e7e34;--muted:#6c757d}
    *{box-sizing:border-box}
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:var(--bg); padding:28px; color:#222 }
    .container { max-width:920px; margin:28px auto; background:var(--card); padding:26px; border-radius:12px; box-shadow:0 10px 30px rgba(15,15,15,0.06); border:1px solid rgba(0,0,0,0.03);} 
    h2{margin:0 0 12px 0; font-size:20px}

    /* Drag & drop area */
    .drop-area{ border:2px dashed rgba(0,0,0,0.08); border-radius:10px; padding:22px; text-align:center; transition:background .15s, border-color .15s; background:linear-gradient(180deg, rgba(0,0,0,0.01), transparent); min-height:84px; display:flex; flex-direction:column; justify-content:center }
    .drop-area.highlight{ border-color:var(--accent); background:rgba(40,167,69,0.03); }
    .drop-area p{ margin:6px 0; color:#444 }

    .controls{ display:flex; gap:14px; align-items:flex-start; margin-top:14px; flex-wrap:wrap }
    label{ font-size:13px; color:#333 }
    input[type=file]{ display:none }
    .btn{ background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600 }
    .btn.secondary{ background:#0d6efd }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .preview { margin-top:18px; display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap }
    .preview img{ max-width:360px; max-height:360px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06) }
    .info{ font-size:14px; color:#444 }
    .note { margin-top:15px; font-size:14px; color:var(--muted) }
    .row{ display:flex; gap:10px; align-items:center }
    input[type=range]{ width:160px }
    input[type=number], select{ width:110px; padding:8px; border-radius:8px; border:1px solid #e6e6e6; background:#fff }
    select{ width:150px }
    .meta { font-size:13px; color:#666 }
    .sizes{ margin-top:10px; font-size:13px }
    progress{ width:100%; height:12px }

    /* Presets */
    .presets{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .presets button{ padding:8px 12px; border-radius:8px; border:1px solid #e6e6e6; background:#fafafa; cursor:pointer; font-size:13px; min-width:88px; text-align:center }
    .presets button.active{ border-color:var(--accent); background:linear-gradient(180deg, rgba(40,167,69,0.08), rgba(40,167,69,0.03)); box-shadow:0 2px 6px rgba(40,167,69,0.06) }

    /* Layout tweaks */
    .col{ display:flex; flex-direction:column; gap:8px }
    .spaced{ display:flex; gap:12px; align-items:center }

    .small-note{ font-size:12px; color:var(--muted); }

    @media (max-width:860px){ .controls{flex-direction:column; align-items:stretch} .preview img{max-width:280px} }
    @media (max-width:520px){ input[type=number], select{ width:100% } }
  </style>
</head>
<body>
  <div class="container">
    <h2>üñºÔ∏è Image Compressor Pro</h2>

    <div id="dropArea" class="drop-area" tabindex="0">
      <p><strong>Drag & drop an image here</strong> ‚Äî or <button id="chooseBtn" class="btn secondary">Choose file</button></p>
      <p class="meta">PNG, JPEG, WebP, AVIF supported. Max file size: 20 MB.</p>
      <input id="imageInput" type="file" accept="image/*" />
    </div>

    <div class="controls">
      <div class="col" style="min-width:260px">
        <label>Size presets</label>
        <div class="presets" id="presets">
          <button data-w="orig" class="active">Original</button>
          <button data-w="640">Small (640)</button>
          <button data-w="1280">Medium (1280)</button>
          <button data-w="1920">Large (1920)</button>
          <button data-w="custom">Custom</button>
        </div>
        <div class="spaced" style="margin-top:6px">
          <div>
            <label for="maxWidth">Max width (px)</label>
            <input id="maxWidth" type="number" min="32" max="8000" value="1920" />
          </div>
          <div>
            <label for="maxHeight">Max height (px)</label>
            <input id="maxHeight" type="number" min="32" max="8000" value="1080" />
          </div>
        </div>
        <div class="small-note">Tip: For best results at small sizes, enable <strong>High-quality downscale</strong> below.</div>
      </div>

      <div class="col">
        <label for="format">Output format</label>
        <select id="format">
          <option value="image/jpeg">JPEG</option>
          <option value="image/webp">WebP</option>
          <option value="image/png">PNG (lossless)</option>
          <option value="image/avif">AVIF</option>
        </select>

        <div style="margin-top:8px">
          <label for="quality">Quality: <span id="qualityVal">80</span>%</label>
          <input id="quality" type="range" min="10" max="100" value="80" />
        </div>

        <div style="margin-top:8px">
          <label><input id="hqDownscale" type="checkbox" checked /> High-quality downscale</label>
        </div>
        <div style="margin-top:4px">
          <label><input id="sharpen" type="checkbox" /> Apply mild sharpening after resize</label>
        </div>
      </div>

      <div style="margin-left:auto; display:flex; flex-direction:column; gap:10px; justify-content:center">
        <button id="compressBtn" class="btn" onclick="compressImage()" disabled>Compress & Download</button>
      </div>
    </div>

    <div class="preview" id="previewArea" style="display:none">
      <div>
        <img id="previewImg" alt="Preview" />
      </div>
      <div class="info">
        <div class="sizes"><strong>Original:</strong> <span id="origSize">-</span></div>
        <div class="sizes"><strong>Compressed:</strong> <span id="compSize">-</span></div>
        <div class="sizes"><strong>Dimensions:</strong> <span id="dimensions">-</span></div>
        <div style="margin-top:10px"><progress id="progress" value="0" max="100" style="display:none"></progress></div>
        <div style="margin-top:10px"><button id="downloadPreview" class="btn" style="display:none">Download compressed</button></div>
      </div>
    </div>

    <p class="note">‚ö° Note: If you choose <strong>PNG</strong>, quality slider is ignored (PNG is lossless). AVIF/WebP support depends on browser. Use presets or Custom to set exact dimensions.</p>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <script>
  (function(){
    // Initialize after DOM is ready to avoid getElementById returning null in some embed contexts
    function init(){
      const dropArea = document.getElementById('dropArea');
      if(!dropArea){ console.warn('Image Compressor Pro: dropArea not found ‚Äî initialization aborted.'); return; }

      const fileInput = document.getElementById('imageInput');
      const chooseBtn = document.getElementById('chooseBtn');
      const previewArea = document.getElementById('previewArea');
      const previewImg = document.getElementById('previewImg');
      const quality = document.getElementById('quality');
      const qualityVal = document.getElementById('qualityVal');
      const maxWidth = document.getElementById('maxWidth');
      const maxHeight = document.getElementById('maxHeight');
      const format = document.getElementById('format');
      const compressBtn = document.getElementById('compressBtn');
      const origSizeEl = document.getElementById('origSize');
      const compSizeEl = document.getElementById('compSize');
      const dimensionsEl = document.getElementById('dimensions');
      const progressEl = document.getElementById('progress');
      const downloadPreviewBtn = document.getElementById('downloadPreview');
      const canvas = document.getElementById('canvas');
      const presetsEl = document.getElementById('presets');
      const hqDownscale = document.getElementById('hqDownscale');
      const sharpen = document.getElementById('sharpen');

      let currentFile = null;
      let lastBlobUrl = null;

      function bytesToSize(bytes){ if(!bytes) return '-'; const sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(1024)); return (bytes/Math.pow(1024,i)).toFixed(2) + ' ' + sizes[i]; }

      function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }

      ['dragenter','dragover','dragleave','drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });

      ['dragenter','dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, ()=> dropArea.classList.add('highlight'), false);
      });

      ['dragleave','drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, ()=> dropArea.classList.remove('highlight'), false);
      });

      dropArea.addEventListener('drop', handleDrop, false)
      chooseBtn.addEventListener('click', ()=> fileInput.click())
      fileInput.addEventListener('change', e=> handleFiles(e.target.files))

      quality.addEventListener('input', ()=> qualityVal.textContent = quality.value)

      function handleDrop(e){ const dt = e.dataTransfer; const files = dt.files; handleFiles(files); }

      function handleFiles(files){ if(!files || !files.length) return; const file = files[0]; if(!file.type.startsWith('image/')){ alert('Please upload an image file.'); return; } if(file.size > 20 * 1024 * 1024){ alert('File too large. Max 20MB.'); return; } currentFile = file; showPreview(file); compressBtn.disabled = false; }

      function showPreview(file){ const reader = new FileReader(); reader.onload = function(e){ previewImg.src = e.target.result; previewArea.style.display = 'flex'; origSizeEl.textContent = bytesToSize(file.size); compSizeEl.textContent = '-'; dimensionsEl.textContent = 'Loading...'; downloadPreviewBtn.style.display = 'none'; progressEl.style.display = 'none';
          // After image loads we can show dimensions
          previewImg.onload = function(){ dimensionsEl.textContent = previewImg.naturalWidth + ' x ' + previewImg.naturalHeight; }
      }; reader.readAsDataURL(file); }

      // Progressive downscale helper: high-quality resizing using multiple steps
      function highQualityResize(img, targetW, targetH){
        // create an offscreen canvas to progressively downscale
        let oc = document.createElement('canvas');
        let ow = img.naturalWidth, oh = img.naturalHeight;
        oc.width = ow; oc.height = oh;
        let octx = oc.getContext('2d');
        octx.imageSmoothingEnabled = true;
        octx.imageSmoothingQuality = 'high';
        octx.drawImage(img, 0, 0, ow, oh);

        // Progressive halving until near target to avoid aliasing
        while(ow * 0.5 > targetW){
          const nw = Math.round(ow * 0.5);
          const nh = Math.round(oh * 0.5);
          const tmp = document.createElement('canvas');
          tmp.width = nw; tmp.height = nh;
          const tctx = tmp.getContext('2d');
          tctx.imageSmoothingEnabled = true;
          tctx.imageSmoothingQuality = 'high';
          tctx.drawImage(oc, 0, 0, ow, oh, 0, 0, nw, nh);
          // replace oc
          oc.width = nw; oc.height = nh;
          octx = oc.getContext('2d');
          octx.imageSmoothingEnabled = true;
          octx.imageSmoothingQuality = 'high';
          octx.clearRect(0,0,nw,nh);
          octx.drawImage(tmp,0,0);
          ow = nw; oh = nh;
        }

        // final draw to target size
        const final = document.createElement('canvas');
        final.width = targetW; final.height = targetH;
        const fctx = final.getContext('2d');
        fctx.imageSmoothingEnabled = true;
        fctx.imageSmoothingQuality = 'high';
        fctx.clearRect(0,0,targetW,targetH);
        fctx.drawImage(oc, 0, 0, ow, oh, 0, 0, targetW, targetH);
        return final;
      }

      // Simple sharpen filter (3x3 kernel) - mild sharpening
      function applySharpen(canvasEl){
        try{
          const w = canvasEl.width, h = canvasEl.height;
          const ctx = canvasEl.getContext('2d');
          const imgData = ctx.getImageData(0,0,w,h);
          const data = imgData.data;
          const copy = new Uint8ClampedArray(data);
          // kernel: [0 -1 0; -1 5 -1; 0 -1 0]
          const k = [0,-1,0, -1,5,-1, 0,-1,0];
          const kk = 3; const half = Math.floor(kk/2);
          for(let y=half; y<h-half; y++){
            for(let x=half; x<w-half; x++){
              let r=0,g=0,b=0;
              let idx=0;
              for(let ky=-half; ky<=half; ky++){
                for(let kx=-half; kx<=half; kx++){
                  const px = x + kx;
                  const py = y + ky;
                  const pidx = (py * w + px) * 4;
                  const kval = k[idx++];
                  r += copy[pidx] * kval;
                  g += copy[pidx+1] * kval;
                  b += copy[pidx+2] * kval;
                }
              }
              const di = (y*w + x)*4;
              data[di] = Math.min(255, Math.max(0, r));
              data[di+1] = Math.min(255, Math.max(0, g));
              data[di+2] = Math.min(255, Math.max(0, b));
              // alpha unchanged
            }
          }
          ctx.putImageData(imgData,0,0);
        }catch(err){ console.warn('Sharpen failed:', err); }
      }

      function compressImage() {
        if(!currentFile) { alert('Please upload an image first.'); return; }

        const outFormat = format.value || 'image/jpeg';
        let q = Math.max(0.01, Math.min(1, parseInt(quality.value,10)/100));
        const maxW = parseInt(maxWidth.value,10) || previewImg.naturalWidth;
        const maxH = parseInt(maxHeight.value,10) || previewImg.naturalHeight;

        // If target small and user chose low quality, bump quality to preserve details
        if(hqDownscale && hqDownscale.checked && maxW <= 640 && q < 0.8){ q = 0.85; }

        const img = new Image();
        const reader = new FileReader();
        reader.onload = function(e){ img.src = e.target.result; }
        reader.readAsDataURL(currentFile);

        progressEl.style.display = 'block';
        progressEl.value = 10;

        img.onload = function(){
          // compute target while preserving aspect
          let [w,h] = [img.naturalWidth, img.naturalHeight];
          let ratio = Math.min(1, Math.min(maxW / w, maxH / h));
          let targetW = Math.round(w * ratio);
          let targetH = Math.round(h * ratio);

          // Use high-quality downscale if requested
          let finalCanvas;
          if(hqDownscale && hqDownscale.checked){
            finalCanvas = highQualityResize(img, targetW, targetH);
          } else {
            // simple draw
            canvas.width = targetW; canvas.height = targetH;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(img, 0, 0, targetW, targetH);
            finalCanvas = canvas;
          }

          // apply optional sharpening
          if(sharpen && sharpen.checked){
            applySharpen(finalCanvas);
          }

          progressEl.value = 50;

          // Convert to blob with given format and quality
          finalCanvas.toBlob(function(blob){
            progressEl.value = 90;
            compSizeEl.textContent = bytesToSize(blob.size);

            const name = (currentFile.name || 'image').replace(/\.[^/.]+$/, '');
            let ext = '.jpg';
            if(outFormat.includes('webp')) ext = '.webp';
            else if(outFormat.includes('png')) ext = '.png';
            else if(outFormat.includes('avif')) ext = '.avif';

            const filename = name + '-compressed' + ext;

            if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
            lastBlobUrl = URL.createObjectURL(blob);

            // Trigger automatic download
            const link = document.createElement('a');
            link.href = lastBlobUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();

            downloadPreviewBtn.style.display = 'inline-block';
            downloadPreviewBtn.onclick = ()=> { const l = document.createElement('a'); l.href = lastBlobUrl; l.download = filename; l.click(); }

            progressEl.value = 100;
            setTimeout(()=>{ progressEl.style.display = 'none'; progressEl.value = 0; }, 700);

          }, outFormat, q);
        };

        img.onerror = function(){ alert('Could not load image for processing.'); progressEl.style.display = 'none'; }
      }

      // Preset handlers
      presetsEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button'); if(!btn) return; [...presetsEl.querySelectorAll('button')].forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const val = btn.dataset.w;
        if(val==='orig'){
          if(previewImg && previewImg.naturalWidth){ maxWidth.value = previewImg.naturalWidth; maxHeight.value = previewImg.naturalHeight; }
        } else if(val==='custom'){
          // leave values as-is and focus
          maxWidth.focus();
        } else {
          maxWidth.value = val; // maintain aspect ratio by adjusting height proportionally
          if(previewImg && previewImg.naturalWidth){ const ratio = previewImg.naturalHeight / previewImg.naturalWidth; maxHeight.value = Math.round(val * ratio); }
        }
      });

      // Keep height in sync when user edits width (for convenience) but only if a preset other than custom is active
      maxWidth.addEventListener('input', ()=>{
        const active = presetsEl.querySelector('button.active'); if(!active) return; if(active.dataset.w==='custom') return; if(previewImg && previewImg.naturalWidth){ const ratio = previewImg.naturalHeight / previewImg.naturalWidth; maxHeight.value = Math.round(maxWidth.value * ratio); }
      });

      // Expose compressImage for old inline onclick (keeps backward compatibility)
      window.compressImage = compressImage;

      // Optional: let user cancel last blob url when unloading
      window.addEventListener('beforeunload', ()=>{ if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl); });

      // attach compressBtn handler defensively
      if(compressBtn) compressBtn.addEventListener('click', compressImage);
    }

    if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
  })();
  </script>
</body>
</html>
